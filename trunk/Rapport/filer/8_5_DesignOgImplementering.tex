\section{Design og Implementering}
\label{ch:DesignImplementering}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% KI   %%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Kontrolinterfacet}
I dette afsnit beskrives design og implementering af Kontrolinterfacet som lavet på baggrund af kravspecifikationen og systemarkitekturen. 

Designet af Kontrolinterfacet afspejler meget den generelle opbygning af systemet. Således er hvert element af systemet implementeret som en klasse. Derudover er der nogle hjælpeklasser. En oversigt over klasserne og deres ansvar kan ses i tabel \ref{tabel:ki-klasser}

Det gælder for VBTE-, SM- og Sensor-klasserne at når der efterspørges en af de værdier, klassen har ansvaret for, så benyttes RS232-objektet til at fremskaffe disse værdier ved hjælp af den serielle kommunikationsprotokol.


\begin{figure}[H]
\centering
\includegraphics[scale=0.8]{billeder/Objektdiagram}
\caption{Oversigt over, og sammenhæng mellem, objekter i kontrolinterface-programmet}
\label{fig:objektdiagram}
\end{figure}


\begin{table}[H]
\centering
\begin{tabular}{| p{3cm}  p{12.5cm}}
\multicolumn{2}{l}{{\Large Kontrolinterfacets klasser}} \\\hline
Kontrolinterface:&Programmets hovedklasse. Eksisterer for at rydde op i main-funktionen.\\\hline
DataServer:&Står for alt TCP-kommunikationen med databasen. Oprettes af KI-klassen\\\hline
Styringsmodul:&Oprettes af KI og opretter VBTE-, Sensor- og RS232klasserne.\\\hline
Sensor:&Oprettes af SM og er ansvarlig for hældningsværdien.\\\hline
VBTE:&Der eksisterer et VBTE-objekt for hvert fysisk VBTE-modul. Det er objektets ansvar at holde styr på værdierne for sit VBTE-modul.\\\hline
RS232:&Objektet oprettes af SM-klassen og VBTE- og Sensorobjekterne har en delt association til den. Objektet har ansvaret for kommunikationen med det fysiske SM-modul. Objektet formidler sig på en protokol forstået den kommunikationsansvarlige kode på SM-modulet. Protokollen kan ses i dokumentet for det detaljerede softwaredesign.\\\hline

MainWindow:&Oprettes af KI-klassen. Kontrollerer og overvåger den grafiske brugergrænsefalde.\\\hline
manudialog:&Oprettes af MainWindow og styrer den dialog, der fremkommer når man ønsker en manuel hældningsregulering.\\\hline
\end{tabular}
\caption{Kontrolinterfacets klasser}
\label{tabel:ki-klasser}
\end{table}
\fxnote{tabellens bredde skal fixes.}
\subsubsection{Grafisk brugergrænseflade}
I denne sektion vil der kort blive gennemgået det vigtigste vindue i den grafiske brugergrænseflade; hovedvinduet. En gennemgang af de resterende vinduer vil kunne findes i Softwaredesign Appendix A: Kontrolinterface.
På figur \ref{fig:hovedvindue} er hovedvinduet vist. Her er vinduets elementer indrammet. En beskrivelse af hvert element vil kunne findes i tabel \ref{tabel:ki-elementer}.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{billeder/hovedvindue}
\label{fig:hovedvindue}
\caption{På figuren ses hovedvinduet for Kontrolinterface-programmet}
\end{figure}


\begin{table}[H]
\label{tabel:ki-elementer}
\begin{tabular}{l p{10cm}}
\multicolumn{2}{l}{{\Large Hovedvinduets elementer}} \\\hline
\hline
\textcolor{red}{\textbf{1: Forsinkelse i sekunder}}
&Det øverste tal fortæller tiden i sekunder siden serveren sidst er blevet opdateret succesfuldt.
Nedenunder udskrives tiden i sekunder siden værdierne i boks tre og fire er blevet opdateret.\\

\textcolor{Orange}{\textbf{2: Nedlukningsknap}}
&Anvendes til at lukke programmet. Programmet åbner dialogen som ses i \ref{fig:lukkevindue}\\

\textcolor{brown}{\textbf{3: Vandballasttankene}}
&Her kan status for vandballasttankene aflæses. Niveauet er hvor fyldt tanken er angivet i procent. Hvis niveauet er over 70\% skrives tallet med rødt.
Status angiver vandets flow i tanken: IND/UD/LUKKET.\\

\textcolor{yellow}{\textbf{4: Hældningssensor}}
&Værdien for hældningen af skibet angives i antal grader og i hvilken side skibet hælder.\\

\textcolor{green}{\textbf{5: Reguleringsstatus}}
&Her angives hvorvidt automatisk eller manuel hældningsregulering er aktiveret. Der vil altid kun være en og kun en af disse aktiveret. Derfor vil der altid være en rød og en grøn indikator tændt. I dette eksempel er den automatisk hældningsregulering aktiveret.\\
\textcolor{pink}{\textbf{6: Forbindelser}}
&Indikerer hvorvidt der er forbindelse til Styringsmodulet og serveren. Dataforbindelse er rød hvis det ikke lykkedes at oprette forbindelse til serveren ved sidste forsøg.
SM-forbindelse er rød hvis det ikke lykkedes at få de ventede svar fra Styringsmodulet.
I denne situation er der forbindelse til styringsmodulet, men ikke serveren.\\

\textcolor{blue}{\textbf{7: Automatisk reguleringsknap}}
&Ved tryk på denne knap vil man komme til dialogen på \ref{fig:aktiver_auto} såfremt automatisk styring ikke er aktiveret. Hvis den er aktiveret og man trykker på knappen vil dialogen på figur \ref{fig:auto_aktiveret} fremkomme.\\

\textcolor{BlueGreen}{\textbf{8: Manuel reguleringsknap}}
&Bringer dig til dialogen på figur \ref{fig:manuelregulering}\\

\textcolor{purple}{\textbf{9: Aktivitetslog}}
&Her udskrives vigtige hændelser i programmet med farvekoder. I dette eksempel kan det ses hvordan alarmer skrives med rødt og oprettede forbindelser skrives med grønt.\\

\end{tabular}
\end{table}
\fxnote{Tabellen "Hovedvinduets elementer" skal fixes både med bredde og streger.}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% VBTE %%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{VBTE}
I dette afsnit beskrives design og implementering af VBTE for både software og hardware. 
\subsubsection{Hardware}
Til VBTE'en er der blevet designet hardware til at styre de to ventiler samt den keramiske ultralydstransmitter og receiver. Hardware er blevet udfærdiget i to dele. Den ene er programeret hardware på PSoC'en, den anden er hardware uden for PSoC'en. Hardware designprocessen til VBTE'en gik igennem 3 faser:
\begin{enumerate}
\item Overordnet design
\item Nedbrydning af blokke
\item Opbygning af design
\end{enumerate}
Gennem disse faser er designet blevet udfærdiget. Fremgangsmåden er anvendt for at overskueligtgøre systemet og lette arbejdet ved at dele systemet op i små dele. På \textit{figur \ref{fig:HWVBTE}} ses det overordnede design af VBTE'en. Der vil i rapporten tages udgangspunkt i ventilkredsen samt receiverdriveren på PSoC'en.
\begin{figure}[H]
\centering
\includegraphics[width = 0.9\textwidth]{billeder/HWVBTE}
\caption{Illustrering af overordnet design af hardware på VBTE.}
\label{fig:HWVBTE}
\end{figure}
\subsubsection{Hardware på PSoC'en}
Hardware opbygget på PSoC'en kunne uden problemer være blevet designet uden for PSoC'en, men PSoC miljøet gør det meget nemt at arbejde med mange forskellige elementer. Der vil i rapporten ligges vægt på transmitterkredsen samt receiverkredsen. På figur \ref{fig:HWVBTE} ses hardware designet på PSoC'en.
\begin{figure}[H]
\centering
\includegraphics[width=0.7\textwidth]{billeder/PSOC_Hardware}
\caption{Hardware på PSoC'en.}
\label{fig:PSOCHW}
\end{figure}
\subsubsection{Transmitterkreds}
Transmitterkredsen står for at sende burst samt at time hvert burst.  Dette opnåes med to clocks, en AND gate, en output pin samt et kontrol register. Transmitterclocken er indstillet til 40kHz da ultralydstransmitteren, ifølge databladet, opererede ved $\SI{40}{kHz}\pm\SI{1}{kHz}$. Clocken er blevet målt på oscilloskop til $\SI{40.3}{kHz}$. Burst kontrolregisteret er anvendt til at AND'e clocken ud på trans\_kontrol pinden.\\
Clock\_dist interruptrutinen sørger for at tælle en variabel op der anvendes i main til at kalde burst funktionen. Dette gøres for at lave et nonblocking delay så andet kan køres på PSoC'en mens en burst er sendt afsted og der afventes detektion.
\subsubsection{Receiverkreds}
Receiverkredsen modtager signalet fra ultralydsreceiveren og omsætter det til en detektion. Dette sker efter følgende opskrift:\\
Løfte signalet $\rightarrow$ Forstærkning $\rightarrow$ Mixning.\\
Signalet bliver løftet på til $\frac{Vdda}{2}$ fordi PSoC'en ikke kan arbejde med værdier under Vssa (GND). Dette gøres ved hjælp af en kondensator, en modstand og en spændingsfølger med $\frac{Vdda}{2}$ på det positive ben.\\
Efter signalet er løftet bliver det forstærket op af en PGA. Efter undersøgelser, hvor der blev sendt burst, er der valgt en forstærkning på 16, da der ca. modtages et signal på $\SI{200}{mV} p-p$.\\
Herefter bliver signalet mixet med $\SI{40}{kHz}$ og filtreret. Efter mixeren giver det, stort set, en DC og summen af de to signaler. Filteret er inbygget i Delta-Sigma ADC'en og har en knækfrekvens ved $\frac{Sample frekvens}{3}$. For at være sikker på at det meste af signalet er kommet over regnes der en opladningstid på filteret til $\SI{1/4}{ms}$. Efter undersøgelser af signalet ind på ADC'en blev en spænding på $\SI{0.3}{V}$.

\subsubsection{Hardware uden for PSoC'en}
Uden for PSoC'en er der lavet 2 hardwareblokke. Disse har til ansvar at omsætte et kontrolsignal til en større spænding over de respektive enheder.
\begin{figure}[H]
	\centering
	\begin{minipage}[b]{0.48\textwidth}\centering
	\includegraphics[width=0.80\textwidth]{billeder/Ventilblok}
	\end{minipage}
	\begin{minipage}[b]{0.48\textwidth}\centering
	\includegraphics[width=0.80\textwidth]{billeder/Transmitterblok}
	\end{minipage}
	\begin{minipage}[t]{0.48\textwidth}
	\caption{Hardwareblok for ventil}
	\label{fig:SMHW1}
	\end{minipage}
	\begin{minipage}[t]{0.48\textwidth}
	\caption{Hardwareblok for transmitteren}
	\label{fig:SMPSOC1}
	\end{minipage}
\end{figure}
\subsubsection{Ventilkreds}
Ventilkredsen får to kontrolsignaler fra PSoC'en og disse skal styre de to ventiler. Ventilerne monteret på kredsen er fra Danfoss og er af modellerne EV210A-1.2 og EV210A-4.5. Disse ventiler drives ved 12V 0.4A. Der er valgt en BD139 transistor til at forstærke signalet op. Denne har en forstærkning mellem 40 og 160 (aflæst fra databladet\footnote{Se bilag/BD139.pdf}). IO's på PSoC'en kan maksimalt trække en strøm på $\SI{4}{mA}$ og det vil i værste tilfælde ikke være nok til at trække ventilerne.\\
Der er derfor lavet en darlington kobling for at mindske belastningen af PSoC'en og for at sikre at der bliver lukket nok op for transistoren. Dette er gjort med en transistor af typen BC547. Transistorne er valgt ud fra pris og tilgængelighed. Der var først valgt en MOSFET IRLZ44n men denne var både for dyr og kunne klare en unødvendig stor effekt. Det smarte ved MOSFET'en er dog at den er spændingsstyret i forhold til de to andre transistorer. 
\subsubsection{Transmitterkreds}
Transmitterkredsen anvender ultralydstranduceren som en højtaler. Denne er koblet over transistoren (Her anvendes også en BD139).\\
\begin{figure}[H]
\begin{minipage}[c]{0.45\textwidth}
Via. kontrolsignalet fra PSoC'en, der bliver sendt ud ved $\SI{40}{kHz}$, bliver der sat en spænding over transduceren.\\ 
Forsyningen hertil trækkes fra samme forsyning som ventilkredsen der bliver leveret fra powersuply'en. Ud fra databladet er der aflæst en ohmsk modstand på omtrendt $\SI{10}{k}\Omega$. Derfor kan PSoC'en uden problemer selv trække denne kreds.
\end{minipage}
\begin{minipage}[c]{0.45\textwidth}
\centering
\includegraphics[width = 1\textwidth]{billeder/transmitterkreds}
\caption{Transmitterkreds}
\end{minipage}
\end{figure}
For yderligere detaljer vedrørende hardware på VBTE henvises til \textit{Deltajeret hardware design}.
\subsubsection{Software}
Softwaren til VBTE modulet er blevet designet til at kunne opfylde kravene i kravspecifikationen samt arkitekturen i systemarkitekturen. Den er blevet designet til at passe til hardwaren så den kan kontrollere de enkelte elementer. I designfasen er der blevet udfærdiget et klassediagram samt en statemachine over funktionaliteten. På \textit{figur \ref{fig:VBTEklasse} } ses klassediagramet for VBTE modulets software.
\begin{figure}[H]
\centering
\includegraphics[width=.8\textwidth]{billeder/ClassVBTE}
\label{fig:VBTEklasse}
\caption{Klassediagram over VBTE}
\end{figure}
Selvom softwaren er skrevet i C er der lavet klasser for alle h-filer for at gøre systemet overskueligt. For detaljerede metodebeskriveler henvises til detaljeret software design.
Selvom softwaren er skrevet i C er der lavet klasser for alle h-filer for at gøre systemet overskueligt. For detaljerede metodebeskriveler henvises til detaljeret software design.\\
For at overskueligtgøre funktionaliteten af softwaren anvendes statemachinediagrammet. Dette viser de forskellige tilstande programmet til enhver til kan befinde sig i.
\begin{figure}[H]
\centering
\includegraphics[width=.8\textwidth]{billeder/STMVBTE}
\caption{Statemachine for VBTE software}
\end{figure}
De forskellige betingelser der skal til for at skifte tilstand vil herefter blive beskrevet. \\
Som nævnt i hardware anvendes et interrupt til at lave et nonblocking delay på 500ms. Dette håndteres på VBTE'en i main ved hjælp af en if sætning der tjekker op på variablen fra interruptet.\\
Burst receivered bliver opnået når flaget hertil bliver sat. Dette flag bliver sat inde i ADC'en interruptrutine når den måler en værdi der indikerer at et burst er modtaget.\\
Read complete betingelsen bliver kontrolleret inde i I2C\_handle. Heri aflæses data fra SM og omsættes til et state for ventilerne. Herefter fyldes afstanden for tankene ind i readbufferen for I2C'en med henblik på at den sendes retur. Herefter ændres ventil tilstanden så den passer med den modtagede tilstand.\\
For yderligere detaljer om software for VBTE henvises til detaljeret design dokumentation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%% SM %%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{SM}
I dette afsnit beskrives design og implementering af SM modulet. SM modulet består af både software og hardware.
\subsubsection{Hardware}
SM modulets hardware består af en konverteringskreds og en PSoC. På PSoC'en er monteret et Kionix KXSC7-2050 accelerometer. Konverteringskredsen anvendes til at sende UART signaler fra PSoC til en KI modulet. Accelerometerets x-akse anvendes til hældningsmålinger for hældningssensorblokken. Designfasen til SM er delt op i 3 faser:
\begin{enumerate}
\item Overordnet design
\item Nedbrydning af blokke
\item Opbygning af design
\end{enumerate}
Denne fremgangsmåde gør det muligt for en udefrakommende at følge med i processen og at kunne implementere modulet så det overholder de krav der er stillet. Ligeledes gør fremgangsmåden det lettere at overskue flere løsninger til hvert problem. på \textit{Figur~\ref{fig:SMHW1}} ses det Overordnede design og på \textit{Figur~\ref{fig:SMPSOC1}} ses PSoC blokken i SM. Der bliver efterfølgende taget udgangspunkt i Hældningssensoren. \\
\begin{figure}[H]
	\centering
	\begin{minipage}[b]{0.48\textwidth}\centering
	\includegraphics[width=0.80\textwidth]{billeder/SMHardware}
	\end{minipage}
	\begin{minipage}[b]{0.48\textwidth}\centering
	\includegraphics[width=0.80\textwidth]{billeder/SMPSoCblock}
	\end{minipage}
	\begin{minipage}[t]{0.48\textwidth}
	\caption{Hardware blok for SM}
	\label{fig:SMHW1}
	\end{minipage}
	\begin{minipage}[t]{0.48\textwidth}
	\caption{PSoC blok for sm}
	\label{fig:SMPSOC1}
	\end{minipage}
\end{figure}
Hældningssensoren består af 2 komponenter: det førnævnte accelerometer samt en DelSig ADC internt i PSoC'en. Valget af accelerometer kommer af at have lavet en række prototyper der ikke mødte vores krav, hvilket accelerometeret i PSoC'en gjorde. Valget af ADC faldt på en DelSig da, den er meget støj immun grundet det indbyggede lavpas filter og har en høj opløsning. Valgte komponenter er illustret på \textit{Figur~\ref{fig:levelsensor}}. ADC konverterer det analoge signal fra, en pin forbundet til, accelerometer til en digital værdi der så senere bliver anvendt i softwaren. For ADC og accelerometerets opsætning se da afsnit \ref{ch:DetajlDesign}~\textit{Detaljeret hardware design} i Bilag.
\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.50\textwidth]{billeder/levelsensor}
	\caption{Hældningssensorens implementering}
	\label{fig:levelsensor}
\end{figure}
\subsubsection{Software}
SM software behandler den konverterede data fra ADC'en samt kommunikation med VBTE og KI modulernerne. Sofwarens udvikling har fulgt de samme faser som hardwaren, hvilket har ført til letforståelig og læselig kode. Softwaren er illustreret på \textit{Figur~\ref{fig:SMKD}}. Der vil efterfølgende blive taget udgangspunkt i et statemachine samt funktionen getFromKI.
\begin{figure}[H]
	\centering
	\includegraphics[width=0.75\textwidth]{billeder/smKlassediagram}
	\caption{Klassediagram for SM}
	\label{fig:SMKD}
\end{figure}
\textbf{SM funktionalitet}\\
Funktionalitet af SM kan bedst beskrives med et state diagram. På \textit{Figur~\ref{fig:SMSTM}} ses  state machine diagrammet for SM modulet. Diagrammet indeholder Automatisk regulering state der beskriver den automatiske regulering i systemet. Den automatiske regulering styres med et flag. Flaget bliver sat når SM opnår forbindelse med KI modulet i 'Afvent' statet. Flaget bliver nulstillet hvis KI sender besked til SM modulet om at det skal termineres, hvorefter SM går tilbage i 'Afvent' statet. Behandlingen af beskeder fra KI i 'Modtag besked fra KI' og 'Send svar til KI' states ses i følgende afsnit \textit{getFromKI}.
\begin{figure}[H]
	\centering
	\includegraphics[width=.8\textwidth]{billeder/stmSM}
	\caption{State machine for SM}
	\label{fig:SMSTM}
\end{figure}
\textbf{getFromKI}\\
Funktionen er bedst beskrevet med et flowdiagram:
\begin{figure}[H]
	\centering
	\includegraphics[width=0.75\textwidth]{billeder/getFromKIflowchart}
	\caption{Flowdiagram for funktionen getFromKI}
	\label{fig:gFKIfc}
\end{figure}
Funktionen har til ansvar at kommunikere med KI efter de krav opsat i Kravspecifikation. Hver ACK er relateret til den besked, der er modtaget, så KI modulet ved hvilken besked, SM har modtaget. Dette sikre pålidelig overførsel. 

\subsection{Database}
Denne section beskriver design og implementering af database delen som er lavet på baggrund af kravspecifikationen og systemarkitekturen.\\
Databasen er blevet opdelt i 2 dele som håndtere denne side. Databasen er opdelt i serveren og web-siden.
\begin{figure}[H]
\centering
\includegraphics[width = 0.5\textwidth]{billeder/database_to_mysql}
\caption{Illustrere overordnet hvordan databasen fungere}
\label{fig:server_to_mysql}
\end{figure}

\subsection{Serveren}
Denne section beskriver design og implementering af serveren.
Opbygningen af severen er gjort i klasser sådan at hver element i severen er implementeret som en klasse se figur \ref{fig:database_server}. Ud over dette benyttes der nogle hjælpeklasser.\\

Det gælder at når KI forsøger at kontakte databasen, tilsluttes denne via tcp som benytter sig af socket. Når tilslutningen er gjort kan der overføres data fra KI til databasen. Dataerne bliver gemt i mySQL databasen. I tilfælde af at der blvier problermer med at gemme, laves der en en tekst fil hvori dataerne bliver lagt og kan så forsøgt gemt af web siden.
\begin{figure}[H]
\centering
\includegraphics[width = 0.5\textwidth]{billeder/database_server}
\caption{Illustrere overordnet hvordan serveren fungere}
\label{fig:database_server}
\end{figure}

\begin{table}[H]
\centering
\begin{tabular}{p{3cm} p{12.5cm}}
\multicolumn{2}{l}{{\Large Serverens klasser}} \\\hline
Server & Er hovedvinduet på serveren. Information til brugeren udskrives herfra og knapper er implementeret. \\
TCP forbindelse (tcp) & Opretter en mulig tcp forbindelse hvor skibet kan tilslutte sig og overføre data.\\
Gemme data (savedata) & Gemmer data til en tekst fil hvis ikke det har været muligt for serveren at få kontakt til mySQL.\\
De kryptering(enumDeKrypteringskode) & Dekryptere level fra sm så data bliver i grader\\
\end{tabular}
\caption{Serverens klasser}
\label{tabel:server-klasser}
\end{table}

\subsection{Web-side}
Denne section beskriver design og implementering af web siden.\\
Opbygningen af web siden er gjort hovedsageligt i php hvor dette gav mening. Desuden er html og styles (css) blevet benyttet til at sikre ens stil på hele web siden og for simpelt at kunne veligeholdes. For at sikre mindst data transmision imellem computer og server er princippet i ajax blevet benyttet.

Når havneterminalen ønsker at se data om skibe der er opkoblet på BROS kan denne tilgå disse via den web baserede database. Når serveren køre kan brugeren tilgå databasen via knappen "Database" ellers kan denne tilgås via den locale adresse. For at komme ind i databasen skal brugeren taste sit password dette gøres for at sikre imod uaotirseret brug af databasen. Efter log ind på siden kan brugeren vælge hvilket skib der skal benyttes. Når skib er valgt komemr brugeren ind på den valgte database. Her kan brugeren se ID på skibet vandtilstand i ballast tanke, hældning og tid siden sidste opdatering (for nærmere se apandix\fxnote{link til apendix}). Hvis serveren har haft problemer med at gemme den nyeste data vil web siden forsøge at gemme som det første inden databasen loades. 

\begin{figure}[H]
\centering
\includegraphics[width = 0.5\textwidth]{billeder/database_web}
\caption{Illustrere overordnet hvordan web-siden fungere}
\label{fig:database_web}
\end{figure}

\begin{table}[H]
\centering
\begin{tabular}{p{3cm} p{12.5cm}}
\multicolumn{2}{l}{{\Large Web sidens beskrivelse}} \\\hline
Hovedvindue (index) & Den første side brugeren kommer til om ikke denne går via serveren \ref{tabel:server-klasser} Denne side loader siden Forside, Om os og Log in ind i sig.\\
Databasen (logon) & Denne side bliver kaldt efter at brugeren er logget på. Denne side loader Skibs valg, bros datasen for skibet, Forside og Om os. 
\end{tabular}
\caption{Web sidens opbygning}
\label{tabel:webside-simpel}
\end{table}